<html>

<head>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <!-- Load required Bootstrap and BootstrapVue CSS -->
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
</head>

<body>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-analytics.js"></script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyCQSAvQmdIOUVXlBFLLPqrF5dNUjslLSVU",
            authDomain: "eft-map-4dd46.firebaseapp.com",
            databaseURL: "https://eft-map-4dd46.firebaseio.com",
            projectId: "eft-map-4dd46",
            storageBucket: "eft-map-4dd46.appspot.com",
            messagingSenderId: "781587830452",
            appId: "1:781587830452:web:8cce1bfb9a8c76b18a69e1",
            measurementId: "G-REVNZ8TMH2"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vue2-leaflet"></script>
    <!-- Load polyfills to support older browsers -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

    <div id="app">
        <b-select id="select-map" name="map" v-model="selectedMap" @change="fetchMarkers">
            <option v-for="map in maps" v-bind:value="map">{{ map.name }}</option>
        </b-select>
        <b-select id="select-marker-color" v-model="selectedMarkerColor">
            <option v-for="color in markerColors">{{ color }}</option>
        </b-select>
        <b-button variant="primary" @click="addMarker">マーカー追加</b-button>
        <b-button variant="outline-danger" @click="removeAllMarker">マーカー全削除</b-button>
        <b-button variant="info" id="change-connection-info" class="float-right" v-b-modal.connection-info>接続情報
        </b-button>
        <b-modal id="connection-info" title="接続情報" @show="showConnection" @ok="updateConnection">
            <label for="user-name">ユーザー名</label>
            <b-input id="user-name" v-model.lazy="inputUserName"></b-input>
            <label for="room-id">Room ID</label>
            <b-input id="room-id" v-model.lazy="inputRoomID"></b-input>
        </b-modal>
        <l-map :bounds="selectedMap.bounds" :min-zoom="minZoom" :crs="crs" :options="mapOptions"
            @update:center="centerUpdated">
            <l-marker :icon="createMarkerIcon(marker)" @click.right="removeMarker(marker)"
                @mouseup.left="updateMarkerPosition(marker)" v-for="marker in markers" :key="marker.id"
                :lat-lng.sync="marker.latlng" :draggable="true">
                <l-popup>{{ marker.author.name }}</l-popup>
            </l-marker>
            <l-image-overlay :url="selectedMap.url" :bounds="selectedMap.bounds" />
        </l-map>
    </div>

    <script>
        Vue.config.devtools = true;

        var { LMap, LImageOverlay, LMarker, LIcon, LPopup } = Vue2Leaflet;
        var db = firebase.firestore();
        const dbMarkersRef = db.collection("markers");
        var unsubscribe;

        new Vue({
            el: "#app",
            components: { LMap, LImageOverlay, LMarker, LIcon, LPopup },
            data() {
                return {
                    center: [],
                    minZoom: -2,
                    crs: L.CRS.Simple,
                    mapOptions: {
                        zoomSnap: 0,
                    },
                    maps: [
                        { name: "Customs", bounds: [[0, 0], [930, 1920]], url: "images/customs.png" },
                        { name: "Factory", bounds: [[0, 0], [821, 1161]], url: "images/factory.png" },
                        { name: "Woods", bounds: [[0, 0], [576, 1024]], url: "images/woods.png" },
                        { name: "Shoreline", bounds: [[0, 0], [742, 1500]], url: "images/shoreline.png" },
                        { name: "Interchange", bounds: [[0, 0], [2800, 4500]], url: "images/interchange.png" },
                        { name: "The Lab", bounds: [[0, 0], [2160, 4096]], url: "images/thelab.png" },
                        { name: "Reserve", bounds: [[0, 0], [616, 1280]], url: "images/reserve.png" }],
                    selectedMap: "",
                    markerColors: [
                        "blue",
                        "red",
                        "green",
                        "yellow",
                        "orange",
                        "violet",
                        "grey",
                        "black",
                    ],
                    selectedMarkerColor: "",
                    markers: [],
                    user: {},
                    inputUserName: "",
                    roomID: "",
                    inputRoomID: ""
                };
            },
            created() {
                firebase.auth().signInAnonymously().catch(function (error) {
                    console.error("Signin error:", error.code + " " + error.message);
                });
            },
            mounted() {
                firebase.auth().onAuthStateChanged(this.onUserLogin);
                this.roomID = localStorage.roomID ? localStorage.roomID : "tarkov"
                this.selectedMap = this.maps[0];
                this.selectedMarkerColor = this.markerColors[0];
                this.fetchMarkers();
            },
            methods: {
                onUserLogin(user) {
                    if (user) {
                        this.user = {
                            uid: user.uid,
                            name: user.displayName ? user.displayName : "scav"
                        };
                    }
                },
                showConnection() {
                    this.inputUserName = this.user.name;
                    this.inputRoomID = this.roomID;
                },
                updateConnection() {
                    this.user.name = this.inputUserName;
                    var user = firebase.auth().currentUser;
                    user.updateProfile({
                        displayName: this.inputUserName
                    });
                    this.roomID = this.inputRoomID;
                    localStorage.roomID = this.inputRoomID;
                },
                createMarkerIcon(marker) {
                    return L.icon({
                        iconUrl: "https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-" + marker.color + ".png",
                        shadowUrl: "images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [13, 41],
                        popupAnchor: [0, -41]
                    })
                },
                fetchMarkers() {
                    // マップ変更前のリスナーをデタッチする
                    if (typeof unsubscribe === "function") {
                        unsubscribe();
                    }

                    // 選択されたマップのマーカーをリスナーで取得
                    unsubscribe = dbMarkersRef.where("roomID", "==", this.roomID).where("map", "==", this.selectedMap.name).onSnapshot((querySnapshot) => {
                        this.markers = [];
                        querySnapshot.forEach((doc) => {
                            let marker = {
                                id: doc.id,
                                latlng: doc.data().latlng,
                                color: doc.data().color,
                                author: doc.data().author
                            }
                            this.markers.push(marker);
                        })
                    },
                        function (error) {
                            console.error("Error listen data:", error);
                        }
                    )
                },
                addMarker() {
                    var marker = {
                        roomID: this.roomID,
                        map: this.selectedMap.name,
                        latlng: { lat: this.center.lat, lng: this.center.lng },
                        color: this.selectedMarkerColor,
                        author: this.user
                    }
                    dbMarkersRef.add(marker)
                        .then(function (docRef) {
                            console.log("Document written with ID: ", docRef.id);
                        })
                        .catch(function (error) {
                            console.error("Error adding document: ", error);
                        })
                },
                removeMarker(marker) {
                    dbMarkersRef.doc(marker.id).delete();
                    console.log("Document deleted: ", marker.id);
                },
                removeAllMarker() {
                    if (confirm("全てのマーカーを削除しますか？")) {
                        var removeTargetQuery = dbMarkersRef.where("roomID", "==", this.roomID).where("map", "==", this.selectedMap.name);
                        removeTargetQuery.get().then(function (querySnapshot) {
                            querySnapshot.forEach(function (doc) {
                                doc.ref.delete();
                            });
                        });
                    }
                },
                updateMarkerPosition(marker) {
                    dbMarkersRef.doc(marker.id).update({
                        latlng: { lat: marker.latlng.lat, lng: marker.latlng.lng }
                    }).catch(function (error) {
                        // The document probably doesn't exist.
                        console.error("Error updating document: ", error);
                    });
                },
                centerUpdated(center) {
                    this.center = center;
                }
            }
        });
    </script>
</body>

</html>